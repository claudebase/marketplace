name: Validate Developer Kit Plugin

on:
  push:
    paths:
      - "developer-kit/**"
  pull_request:
    paths:
      - "developer-kit/**"
  workflow_dispatch:

jobs:
  validate:
    name: Validate on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq (if needed)
        run: |
          if ! command -v jq &> /dev/null; then
            if [[ "$OSTYPE" == "darwin"* ]]; then
              brew install jq
            else
              sudo apt-get update && sudo apt-get install -y jq
            fi
          fi
          jq --version

      - name: Display shell version
        run: bash --version

      - name: Validate Bash script syntax
        working-directory: developer-kit
        run: |
          for script in hooks/*.sh scripts/*.sh; do
            echo "Checking $script..."
            bash -n "$script"
          done
          echo "All scripts have valid syntax"

      - name: Run comprehensive test suite
        working-directory: developer-kit
        run: bash scripts/test_components.sh --verbose

      - name: Run unified validation
        working-directory: developer-kit
        run: bash scripts/validate.sh

      - name: Run CI tests
        working-directory: developer-kit
        run: bash scripts/ci_tests.sh

      - name: Validate delegation compliance
        working-directory: developer-kit
        run: bash scripts/validate_delegation.sh

      - name: Validate JSON configuration files
        working-directory: developer-kit
        run: |
          echo "Validating .mcp.json..."
          jq empty .mcp.json
          echo "Validating .lsp.json..."
          jq empty .lsp.json
          echo "Validating hooks/hooks.json..."
          jq empty hooks/hooks.json
          echo "Validating .claude-plugin/plugin.json..."
          jq empty .claude-plugin/plugin.json
          echo "All JSON files are valid"

  # Summary job that requires all matrix jobs to pass
  validation-summary:
    name: Validation Summary
    needs: validate
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check validation results
        run: |
          if [ "${{ needs.validate.result }}" != "success" ]; then
            echo "Validation failed on one or more platforms"
            exit 1
          fi
          echo "All platform validations passed successfully!"
